name: Test Workflow

on:
  workflow_dispatch:
    inputs:
      dict_param:
        description: 'JSON dictionary parameter'
        required: true
        default: '{"env": "development", "test_case_method": "ec2-al2", "dynamic_variable_path": "" }'
      email_id:
        description: 'Email ID for notifications'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: "3.12"
  GITHUB_RUN_ID: ${{ github.run_id }}
  GITHUB_REPOSITORY: ${{ github.repository }}
  GITHUB_WORKFLOW: ${{ github.workflow }}
  GITHUB_JOB: ${{ github.job }}

jobs:
  Instance:
    runs-on: ubuntu-latest
    environment: ${{ fromJson(github.event.inputs.dict_param).env }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Parse Input Parameters and Set Environment Variables
      id: parse_input
      run: |
        echo "Parsing JSON dictionary input..."
        INPUT_DICT='${{ github.event.inputs.dict_param }}'

        # Parse JSON with jq
        env=$(echo "$INPUT_DICT" | jq -r '.env')
        test_case_method=$(echo "$INPUT_DICT" | jq -r '.test_case_method')
        dynamic_variable_path=$(echo "$INPUT_DICT" | jq -r '.dynamic_variable_path')

        # Get email_id directly from input
        email_id="${{ github.event.inputs.email_id }}"

        # Determine dynamic variable path if not explicitly provided
        if [[ -z "$dynamic_variable_path" ]]; then
          case "$test_case_method" in
            ec2-al2)
              dynamic_variable_path="catalog-ui/tests/aws_Linux.robot"
              ;;
            ec2-win)
              dynamic_variable_path="catalog-ui/tests/aws_Windows.robot"
              ;;
            api-api1)
              dynamic_variable_path="catalog-ui/tests/api-api1.json"
              ;;
            api-api2)
              dynamic_variable_path="catalog-ui/tests/api-api2.json"
              ;;
            *)
              echo "Error: Unsupported test case method $test_case_method"
              exit 1
              ;;
          esac
        fi

        # Construct the test case command
        test_case_command="python -m robot --outputdir Reports --listener allure_robotframework:allure-results $dynamic_variable_path"

        echo "Environment: $env"
        echo "Test Case Method: $test_case_method"
        echo "Email ID: $email_id"
        echo "Dynamic Variable Path: $dynamic_variable_path"
        echo "Test Case Command: $test_case_command"

        # Validate environment
        valid_envs=("development" "test" "production")
        if [[ ! " ${valid_envs[@]} " =~ " ${env} " ]]; then
          echo "Error: Invalid environment. Must be development, test, or production."
          exit 1
        fi

        # Export parsed values as environment variables
        echo "EMAIL_ID=$email_id" >> $GITHUB_ENV
        echo "TEST_CASE_METHOD=$test_case_method" >> $GITHUB_ENV
        echo "DYNAMIC_VARIABLE_PATH=$dynamic_variable_path" >> $GITHUB_ENV
        echo "TEST_CASE_COMMAND=$test_case_command" >> $GITHUB_ENV

    - name: Set Up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Dependencies
      run: |
        if [[ "$TEST_CASE_METHOD" == "ec2-al2" || "$TEST_CASE_METHOD" == "ec2-win" ]]; then
          pip install -r ec2-requirements.txt
        else
          pip install -r api-requirements.txt
        fi

    - name: Execute Test Case
      run: |
        echo "Running test case command: ${{ env.TEST_CASE_COMMAND }}"
        # ${{ env.TEST_CASE_COMMAND }}
